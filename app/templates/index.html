<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pneumonia Detection</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <!-- Modal-like card -->
  <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-lg">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-gray-800">Upload Chest X-ray</h2>
      <button onclick="resetForm()" class="text-gray-500 hover:text-gray-700">✕</button>
    </div>

    <!-- Upload area -->
    <label id="upload-area"
           for="file-input"
           class="flex flex-col items-center justify-center w-full h-40 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
      <div class="flex flex-col items-center justify-center">
        <svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5.002 5.002 0 0115.9 6H16a5 5 0 010 10h-1"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <p class="text-sm text-gray-500">Click to upload or drag & drop</p>
      </div>
      <input id="file-input" type="file" class="hidden" accept="image/*" />
    </label>

    <!-- Preview -->
    <div id="preview" class="mt-4 hidden">
      <img id="preview-img" src="" class="w-full h-48 object-contain rounded-lg border" />
    </div>

    <!-- Actions -->
    <div class="flex justify-between mt-6">
      <button id="cancel-btn" onclick="resetForm()"
              class="px-4 py-2 border rounded-lg text-gray-600 hover:bg-gray-100">Cancel</button>
      <button id="upload-btn" onclick="submitForm()"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
        <span id="upload-btn-text">Upload & Predict</span>
      </button>
    </div>

    <!-- Result -->
    <div id="result" class="mt-4 text-center text-gray-700 font-medium" aria-live="polite"></div>
  </div>

  <script>
    const fileInput = document.getElementById("file-input");
    const preview = document.getElementById("preview");
    const previewImg = document.getElementById("preview-img");
    const resultDiv = document.getElementById("result");
    const uploadBtn = document.getElementById("upload-btn");
    const uploadBtnText = document.getElementById("upload-btn-text");
    const uploadArea = document.getElementById("upload-area");

    // Preview selected file
    fileInput.addEventListener("change", () => {
      const file = fileInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImg.src = e.target.result;
          preview.classList.remove("hidden");
        };
        reader.readAsDataURL(file);
      }
    });

    // Optional: basic drag & drop support to update input file
    ["dragenter", "dragover"].forEach(evt =>
      uploadArea.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        uploadArea.classList.add("bg-gray-100", "ring-2", "ring-blue-200");
      })
    );
    ["dragleave", "drop"].forEach(evt =>
      uploadArea.addEventListener(evt, (e) => {
        e.preventDefault(); e.stopPropagation();
        uploadArea.classList.remove("bg-gray-100", "ring-2", "ring-blue-200");
      })
    );
    uploadArea.addEventListener("drop", (e) => {
      const dt = e.dataTransfer;
      if (dt && dt.files && dt.files.length) {
        fileInput.files = dt.files;
        fileInput.dispatchEvent(new Event('change'));
      }
    });

    function resetForm() {
      fileInput.value = "";
      previewImg.src = "";
      preview.classList.add("hidden");
      resultDiv.innerHTML = "";
      enableButton();
    }

    function disableButton() {
      uploadBtn.setAttribute("disabled", "true");
      uploadBtn.classList.add("opacity-60", "cursor-not-allowed");
      uploadBtnText.innerHTML = '⏳ Processing...';
      // optional spinner
      if (!document.getElementById("btn-spinner")) {
        const spinner = document.createElement("span");
        spinner.id = "btn-spinner";
        spinner.className = "w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin inline-block";
        uploadBtn.prepend(spinner);
      }
    }

    function enableButton() {
      uploadBtn.removeAttribute("disabled");
      uploadBtn.classList.remove("opacity-60", "cursor-not-allowed");
      uploadBtnText.innerHTML = "Upload & Predict";
      const spinner = document.getElementById("btn-spinner");
      if (spinner) spinner.remove();
    }

    async function submitForm() {
      if (!fileInput.files.length) {
        alert("Please select an image.");
        return;
      }

      const formData = new FormData();
      formData.append("file", fileInput.files[0]);

      // UI state
      resultDiv.innerHTML = "";
      disableButton();

      try {
        const response = await fetch("/predict", {
          method: "POST",
          body: formData
        });

        let result;
        // try parse json; if invalid, show status
        try {
          result = await response.json();
        } catch (err) {
          throw new Error(`Server returned ${response.status} ${response.statusText}`);
        }

        if (!response.ok) {
          // server returned error code - try to show meaningful message
          const message = result && (result.error || result.detail || JSON.stringify(result)) || response.statusText;
          resultDiv.innerHTML = `<p class="text-red-600">❌ ${message}</p>`;
          enableButton();
          return;
        }

        // Successful response
        // Expected shape:
        // { prediction: "PNEUMONIA", confidence: 0.9725, probabilities: { NORMAL: 0.0275, PNEUMONIA: 0.9725 } }
        const pred = result.prediction || "Unknown";
        const conf = parseFloat(result.confidence) || 0;
        const probs = result.probabilities || null;

        // Build HTML output
        let html = `
          <div class="mb-3">
            <p class="text-lg">Prediction:
              <span class="font-bold text-blue-600"> ${pred}</span>
            </p>
            <p class="text-sm text-gray-600">Confidence: <span class="font-semibold">${(conf * 100).toFixed(2)}%</span></p>
          </div>
        `;

        if (probs && typeof probs === 'object') {
          // Sort classes by probability descending
          const entries = Object.entries(probs).map(([k, v]) => [k, parseFloat(v)]);
          entries.sort((a,b) => b[1] - a[1]);

          html += `<div class="space-y-3 mt-3 text-left">`;
          for (const [label, p] of entries) {
            const pct = Math.max(0, Math.min(100, (p * 100)));
            html += `
              <div>
                <div class="flex justify-between mb-1">
                  <span class="text-sm font-medium text-gray-700">${label}</span>
                  <span class="text-sm font-medium text-gray-600">${pct.toFixed(2)}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
                  <div class="h-3 rounded-full ${label === pred ? 'bg-blue-600' : 'bg-gray-500/60'}" style="width: ${pct}%;"></div>
                </div>
              </div>
            `;
          }
          html += `</div>`;
        } else {
          // If probabilities not provided, show raw result as fallback
          html += `<pre class="text-xs text-left mt-3 bg-gray-50 p-3 rounded">${JSON.stringify(result, null, 2)}</pre>`;
        }

        resultDiv.innerHTML = html;
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = `<p class="text-red-600">⚠️ Request failed: ${err.message}</p>`;
      } finally {
        enableButton();
      }
    }
  </script>
</body>
</html>
